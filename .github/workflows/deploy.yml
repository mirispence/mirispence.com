name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      action:
        description: "deploy or rollback"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - rollback

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy') }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -euo pipefail

            APP_ROOT="${{ secrets.APP_ROOT }}"
            REPO="${{ github.repository }}"
            BRANCH="${{ secrets.DEPLOY_BRANCH || 'main' }}"
            KEEP="${{ secrets.KEEP_RELEASES || 5 }}"

            RELEASES_DIR="$APP_ROOT/releases"
            SHARED_DIR="$APP_ROOT/shared"
            TS="$(date +%Y%m%d_%H%M%S)"
            RELEASE_DIR="$RELEASES_DIR/$TS"

            mkdir -p "$RELEASES_DIR" "$SHARED_DIR"

            if [ ! -f "$SHARED_DIR/.env" ]; then
              echo "Missing shared .env at $SHARED_DIR/.env"
              exit 1
            fi

            echo "Creating release $RELEASE_DIR"
            mkdir -p "$RELEASE_DIR"

            echo "Cloning repository"
            git clone --depth 1 --branch "$BRANCH" "https://github.com/$REPO.git" "$RELEASE_DIR"

            cd "$RELEASE_DIR"

            echo "Linking shared paths"
            rm -rf "$RELEASE_DIR/storage"
            ln -sfn "$SHARED_DIR/storage" "$RELEASE_DIR/storage"

            mkdir -p "$SHARED_DIR/uploads"
            rm -rf "$RELEASE_DIR/public/uploads"
            ln -sfn "$SHARED_DIR/uploads" "$RELEASE_DIR/public/uploads"

            ln -sfn "$SHARED_DIR/.env" "$RELEASE_DIR/.env"

            echo "Installing PHP deps"
            composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

            echo "Building assets"
            npm ci
            npm run build

            echo "Laravel maintenance tasks"
            php artisan key:generate --force || true
            php artisan storage:link || true

            php artisan migrate --force

            php artisan config:clear
            php artisan route:clear
            php artisan view:clear

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "Flip current symlink"
            ln -sfn "$RELEASE_DIR" "$APP_ROOT/current"

            echo "Reload PHP-FPM if available"
            sudo -n systemctl reload php8.3-fpm 2>/dev/null || true
            sudo -n systemctl reload php8.2-fpm 2>/dev/null || true

            echo "Cleanup old releases"
            cd "$RELEASES_DIR"
            ls -1dt */ | tail -n +$((KEEP + 1)) | xargs -r rm -rf

            echo "Deploy complete: $TS"

  rollback:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.action == 'rollback' }}
    runs-on: ubuntu-latest

    steps:
      - name: Rollback over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -euo pipefail

            APP_ROOT="${{ secrets.APP_ROOT }}"
            RELEASES_DIR="$APP_ROOT/releases"

            cd "$RELEASES_DIR"

            PREV="$(ls -1dt */ | sed -n '2p' | tr -d '/')"
            if [ -z "$PREV" ]; then
              echo "No previous release found."
              exit 1
            fi

            ln -sfn "$RELEASES_DIR/$PREV" "$APP_ROOT/current"

            sudo -n systemctl reload php8.3-fpm 2>/dev/null || true
            sudo -n systemctl reload php8.2-fpm 2>/dev/null || true

            echo "Rolled back to: $PREV"
